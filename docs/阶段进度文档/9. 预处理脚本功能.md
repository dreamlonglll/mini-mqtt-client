# 阶段九：预处理脚本功能 - 进度文档

## 完成状态：已完成

## 任务完成情况

### 9.1 脚本管理入口
- [x] 在 CommandBar 添加"管理脚本"按钮
- [x] 通过事件链传递到 App.vue 控制对话框
- [x] 校验需要先选择服务器

### 9.2 脚本管理对话框
- [x] 创建 ScriptDialog.vue 组件
- [x] 左侧脚本列表展示
- [x] 脚本启用/禁用开关
- [x] 右侧脚本编辑区
- [x] 支持新增脚本
- [x] 支持编辑脚本
- [x] 支持删除脚本

### 9.3 脚本数据模型
- [x] 后端 Script 模型定义
- [x] 脚本 CRUD API 实现
- [x] 前端 script.ts Store 实现
- [x] 脚本数据持久化

### 9.4 脚本执行引擎
- [x] 创建 scriptEngine.ts 执行引擎
- [x] 实现 JavaScript 沙箱环境
- [x] 提供安全的执行上下文
- [x] 支持 process 函数调用
- [x] 支持异步脚本执行

### 9.5 脚本集成
- [x] 发送消息时应用 before_publish 脚本（PublishPanel）
- [x] 定时发布时应用 before_publish 脚本（ScheduledPublishDialog）
- [x] 接收消息时应用 after_receive 脚本（mqtt.ts）

## 相关提交

- feat: 实现预处理脚本功能

## 文件变更

### 新增文件
- src/components/script/ScriptDialog.vue - 脚本管理对话框
- src/stores/script.ts - 脚本状态管理
- src/utils/scriptEngine.ts - 脚本执行引擎
- src-tauri/src/commands/script.rs - 脚本 API 命令

### 修改文件
- src/App.vue - 添加脚本对话框
- src/components/layout/AppLayout.vue - 添加脚本事件传递
- src/components/layout/CommandBar.vue - 添加"管理脚本"按钮
- src/components/mqtt/PublishPanel.vue - 集成发送前脚本
- src/components/mqtt/ScheduledPublishDialog.vue - 集成发送前脚本
- src/stores/mqtt.ts - 集成接收后脚本
- src-tauri/src/commands/mod.rs - 添加 script 模块
- src-tauri/src/lib.rs - 注册脚本命令
- src-tauri/src/db/mod.rs - 添加脚本存储方法
- src-tauri/src/db/models.rs - 添加 Script 模型

## 技术要点

### 脚本执行沙箱
- 使用 `new Function()` 创建隔离执行环境
- 限制可访问的全局对象
- 支持 console、JSON、基础数据类型等安全 API

### 脚本执行流程
1. 获取当前服务器启用的脚本
2. 按顺序执行每个脚本的 process 函数
3. 将上一个脚本的输出作为下一个脚本的输入
4. 脚本执行失败时保留原始值并继续

## 测试要点

1. 脚本管理：新增/编辑/删除/启用/禁用功能
2. 发送前脚本：验证 payload 被正确处理
3. 接收后脚本：验证收到的消息被正确处理
4. 脚本异常：验证脚本错误不影响正常功能
5. 多脚本链式：验证多个脚本按顺序执行
