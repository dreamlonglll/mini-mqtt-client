# 阶段一：基础架构搭建

## 目标概述

搭建项目的基础架构，包括前端 UI 框架配置、状态管理、主题系统，以及后端数据库和 MQTT 库的集成。

## 任务清单

### 1.1 前端依赖安装

#### 任务描述
安装 Element Plus、Pinia 及相关依赖

#### 执行命令
```bash
npm install element-plus @element-plus/icons-vue pinia
npm install -D unplugin-auto-import unplugin-vue-components sass
```

#### 验收标准
- package.json 中包含所有依赖
- npm install 无报错

---

### 1.2 配置 Element Plus 自动导入

#### 任务描述
配置 Vite 插件实现 Element Plus 组件和 API 的自动导入

#### 修改文件
`vite.config.ts`

#### 代码实现
```typescript
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import AutoImport from "unplugin-auto-import/vite";
import Components from "unplugin-vue-components/vite";
import { ElementPlusResolver } from "unplugin-vue-components/resolvers";

const host = process.env.TAURI_DEV_HOST;

export default defineConfig({
  plugins: [
    vue(),
    AutoImport({
      resolvers: [ElementPlusResolver()],
      imports: ["vue", "pinia"],
      dts: "src/auto-imports.d.ts",
    }),
    Components({
      resolvers: [ElementPlusResolver()],
      dts: "src/components.d.ts",
    }),
  ],
  clearScreen: false,
  server: {
    port: 1420,
    strictPort: true,
    host: host || false,
    hmr: host ? { protocol: "ws", host, port: 1421 } : undefined,
    watch: { ignored: ["**/src-tauri/**"] },
  },
});
```

#### 验收标准
- 组件可以直接使用无需手动 import
- 生成 auto-imports.d.ts 和 components.d.ts

---

### 1.3 配置 Pinia 状态管理

#### 任务描述
初始化 Pinia 并创建基础 Store 结构

#### 新增文件
- `src/stores/index.ts` - Pinia 实例
- `src/stores/app.ts` - 应用全局状态（主题等）

#### 代码实现

**src/stores/index.ts**
```typescript
import { createPinia } from "pinia";

const pinia = createPinia();

export default pinia;
```

**src/stores/app.ts**
```typescript
import { defineStore } from "pinia";
import { ref } from "vue";

export const useAppStore = defineStore("app", () => {
  // 主题：light / dark
  const theme = ref<"light" | "dark">("light");

  // 切换主题
  const toggleTheme = () => {
    theme.value = theme.value === "light" ? "dark" : "light";
    applyTheme();
  };

  // 设置主题
  const setTheme = (newTheme: "light" | "dark") => {
    theme.value = newTheme;
    applyTheme();
  };

  // 应用主题到 DOM
  const applyTheme = () => {
    if (theme.value === "dark") {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  };

  // 初始化主题（从系统偏好或本地存储）
  const initTheme = () => {
    const stored = localStorage.getItem("theme");
    if (stored === "light" || stored === "dark") {
      theme.value = stored;
    } else if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
      theme.value = "dark";
    }
    applyTheme();
  };

  return {
    theme,
    toggleTheme,
    setTheme,
    initTheme,
  };
});
```

#### 修改文件
`src/main.ts` - 注册 Pinia

```typescript
import { createApp } from "vue";
import App from "./App.vue";
import pinia from "./stores";
import "element-plus/theme-chalk/dark/css-vars.css";

const app = createApp(App);
app.use(pinia);
app.mount("#app");
```

#### 验收标准
- Pinia 正常工作
- useAppStore 可以正常使用

---

### 1.4 配置深浅色主题切换

#### 任务描述
实现 Element Plus 深浅色主题切换

#### 新增文件
- `src/assets/styles/index.scss` - 全局样式
- `src/assets/styles/variables.scss` - CSS 变量

#### 代码实现

**src/assets/styles/variables.scss**
```scss
:root {
  --app-bg-color: #f5f7fa;
  --app-text-color: #303133;
  --app-border-color: #dcdfe6;
  --sidebar-bg: #ffffff;
  --sidebar-width: 280px;
}

html.dark {
  --app-bg-color: #141414;
  --app-text-color: #e5eaf3;
  --app-border-color: #414243;
  --sidebar-bg: #1d1d1d;
}
```

**src/assets/styles/index.scss**
```scss
@use "./variables.scss";

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html,
body,
#app {
  width: 100%;
  height: 100%;
  overflow: hidden;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
    Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
  background-color: var(--app-bg-color);
  color: var(--app-text-color);
  transition: background-color 0.3s, color 0.3s;
}

// 滚动条样式
::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-thumb {
  background-color: var(--el-border-color);
  border-radius: 3px;
}

::-webkit-scrollbar-track {
  background-color: transparent;
}
```

#### 修改文件
`src/main.ts` - 引入样式

```typescript
import { createApp } from "vue";
import App from "./App.vue";
import pinia from "./stores";
import "element-plus/theme-chalk/dark/css-vars.css";
import "./assets/styles/index.scss";

const app = createApp(App);
app.use(pinia);
app.mount("#app");
```

#### 验收标准
- 深色/浅色主题可切换
- 主题状态持久化到 localStorage

---

### 1.5 创建基础布局组件

#### 任务描述
创建应用的主布局结构

#### 新增文件
- `src/components/layout/AppLayout.vue` - 主布局
- `src/components/layout/Sidebar.vue` - 左侧边栏
- `src/components/layout/Header.vue` - 顶部栏

#### 代码实现

**src/components/layout/AppLayout.vue**
```vue
<template>
  <div class="app-layout">
    <Sidebar class="app-sidebar" />
    <div class="app-main">
      <Header class="app-header" />
      <div class="app-content">
        <slot />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import Sidebar from "./Sidebar.vue";
import Header from "./Header.vue";
</script>

<style scoped lang="scss">
.app-layout {
  display: flex;
  width: 100%;
  height: 100%;
}

.app-sidebar {
  width: var(--sidebar-width);
  flex-shrink: 0;
}

.app-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.app-header {
  flex-shrink: 0;
}

.app-content {
  flex: 1;
  overflow: auto;
  padding: 16px;
}
</style>
```

**src/components/layout/Sidebar.vue**
```vue
<template>
  <div class="sidebar">
    <div class="sidebar-header">
      <h1 class="sidebar-title">MQTT Client</h1>
    </div>
    <div class="sidebar-content">
      <div class="server-list">
        <div class="section-title">
          <span>Server 列表</span>
          <el-button type="primary" size="small" :icon="Plus" circle />
        </div>
        <el-empty v-if="true" description="暂无 Server" :image-size="80" />
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { Plus } from "@element-plus/icons-vue";
</script>

<style scoped lang="scss">
.sidebar {
  height: 100%;
  background-color: var(--sidebar-bg);
  border-right: 1px solid var(--app-border-color);
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--app-border-color);
}

.sidebar-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--app-text-color);
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

.section-title {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  font-size: 14px;
  font-weight: 500;
  color: var(--el-text-color-secondary);
}
</style>
```

**src/components/layout/Header.vue**
```vue
<template>
  <div class="header">
    <div class="header-left">
      <span class="current-server">未连接</span>
    </div>
    <div class="header-right">
      <el-button :icon="themeIcon" circle @click="toggleTheme" />
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from "vue";
import { Sunny, Moon } from "@element-plus/icons-vue";
import { useAppStore } from "@/stores/app";

const appStore = useAppStore();

const themeIcon = computed(() =>
  appStore.theme === "light" ? Moon : Sunny
);

const toggleTheme = () => {
  appStore.toggleTheme();
  localStorage.setItem("theme", appStore.theme);
};
</script>

<style scoped lang="scss">
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background-color: var(--sidebar-bg);
  border-bottom: 1px solid var(--app-border-color);
}

.current-server {
  font-size: 14px;
  color: var(--el-text-color-secondary);
}
</style>
```

#### 验收标准
- 布局正常显示
- 主题切换按钮工作正常

---

### 1.6 配置路径别名

#### 任务描述
配置 TypeScript 和 Vite 的路径别名

#### 修改文件
- `vite.config.ts`
- `tsconfig.json`

#### 代码实现

**vite.config.ts** 添加:
```typescript
import { resolve } from "path";

export default defineConfig({
  // ... 其他配置
  resolve: {
    alias: {
      "@": resolve(__dirname, "src"),
    },
  },
});
```

**tsconfig.json** 添加:
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}
```

#### 验收标准
- `@/` 别名在 import 中正常工作
- TypeScript 类型提示正常

---

### 1.7 Rust 后端依赖安装

#### 任务描述
添加 SQLite、MQTT 和其他必要的 Rust 依赖

#### 修改文件
`src-tauri/Cargo.toml`

#### 代码实现
```toml
[dependencies]
tauri = { version = "2", features = [] }
tauri-plugin-opener = "2"
serde = { version = "1", features = ["derive"] }
serde_json = "1"
rumqttc = "0.24"
rusqlite = { version = "0.32", features = ["bundled"] }
tokio = { version = "1", features = ["full"] }
thiserror = "2.0"
chrono = { version = "0.4", features = ["serde"] }
uuid = { version = "1.11", features = ["v4"] }
parking_lot = "0.12"
```

#### 验收标准
- `cargo build` 编译成功
- 所有依赖正确解析

---

### 1.8 数据库初始化模块

#### 任务描述
创建 SQLite 数据库初始化和表结构创建

#### 新增文件
- `src-tauri/src/db/mod.rs`
- `src-tauri/src/db/models.rs`

#### 代码实现

**src-tauri/src/db/mod.rs**
```rust
pub mod models;

use rusqlite::{Connection, Result};
use std::path::PathBuf;
use std::sync::Mutex;
use tauri::AppHandle;
use tauri::Manager;

pub struct Database {
    pub conn: Mutex<Connection>,
}

impl Database {
    pub fn new(app_handle: &AppHandle) -> Result<Self> {
        let app_dir = app_handle
            .path()
            .app_data_dir()
            .expect("Failed to get app data dir");
        
        std::fs::create_dir_all(&app_dir).expect("Failed to create app data dir");
        
        let db_path = app_dir.join("mqtt_client.db");
        let conn = Connection::open(db_path)?;
        
        let db = Self {
            conn: Mutex::new(conn),
        };
        
        db.init_tables()?;
        Ok(db)
    }

    fn init_tables(&self) -> Result<()> {
        let conn = self.conn.lock().unwrap();
        
        conn.execute_batch(
            "
            -- MQTT Server 配置表
            CREATE TABLE IF NOT EXISTS mqtt_servers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                host TEXT NOT NULL,
                port INTEGER DEFAULT 1883,
                protocol_version TEXT DEFAULT '3.1.1',
                username TEXT,
                password TEXT,
                client_id TEXT,
                keep_alive INTEGER DEFAULT 60,
                clean_session INTEGER DEFAULT 1,
                use_tls INTEGER DEFAULT 0,
                ca_cert TEXT,
                client_cert TEXT,
                client_key TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
            );

            -- 命令模板表
            CREATE TABLE IF NOT EXISTS command_templates (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                server_id INTEGER NOT NULL,
                name TEXT NOT NULL,
                topic TEXT NOT NULL,
                payload TEXT,
                qos INTEGER DEFAULT 0,
                retain INTEGER DEFAULT 0,
                category TEXT,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (server_id) REFERENCES mqtt_servers(id) ON DELETE CASCADE
            );

            -- 历史消息表
            CREATE TABLE IF NOT EXISTS message_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                server_id INTEGER NOT NULL,
                direction TEXT NOT NULL,
                topic TEXT NOT NULL,
                payload BLOB,
                qos INTEGER DEFAULT 0,
                retain INTEGER DEFAULT 0,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (server_id) REFERENCES mqtt_servers(id) ON DELETE CASCADE
            );

            -- 订阅记录表
            CREATE TABLE IF NOT EXISTS subscriptions (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                server_id INTEGER NOT NULL,
                topic TEXT NOT NULL,
                qos INTEGER DEFAULT 0,
                created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (server_id) REFERENCES mqtt_servers(id) ON DELETE CASCADE
            );
            "
        )?;
        
        Ok(())
    }
}
```

**src-tauri/src/db/models.rs**
```rust
use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MqttServer {
    pub id: Option<i64>,
    pub name: String,
    pub host: String,
    pub port: i32,
    pub protocol_version: String,
    pub username: Option<String>,
    pub password: Option<String>,
    pub client_id: Option<String>,
    pub keep_alive: i32,
    pub clean_session: bool,
    pub use_tls: bool,
    pub ca_cert: Option<String>,
    pub client_cert: Option<String>,
    pub client_key: Option<String>,
    pub created_at: Option<String>,
    pub updated_at: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct CommandTemplate {
    pub id: Option<i64>,
    pub server_id: i64,
    pub name: String,
    pub topic: String,
    pub payload: Option<String>,
    pub qos: i32,
    pub retain: bool,
    pub category: Option<String>,
    pub created_at: Option<String>,
    pub updated_at: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct MessageHistory {
    pub id: Option<i64>,
    pub server_id: i64,
    pub direction: String, // "publish" or "receive"
    pub topic: String,
    pub payload: Option<Vec<u8>>,
    pub qos: i32,
    pub retain: bool,
    pub timestamp: Option<String>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Subscription {
    pub id: Option<i64>,
    pub server_id: i64,
    pub topic: String,
    pub qos: i32,
    pub created_at: Option<String>,
}
```

#### 修改文件
`src-tauri/src/lib.rs` - 初始化数据库

```rust
mod db;

use db::Database;
use tauri::Manager;

#[cfg_attr(mobile, tauri::mobile_entry_point)]
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_opener::init())
        .setup(|app| {
            let db = Database::new(&app.handle())?;
            app.manage(db);
            Ok(())
        })
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

#### 验收标准
- 应用启动时自动创建数据库
- 表结构正确创建

---

## 完成检查清单

- [ ] Element Plus 安装并配置自动导入
- [ ] Pinia 状态管理配置完成
- [ ] 深浅色主题切换正常工作
- [ ] 基础布局组件创建完成
- [ ] 路径别名配置完成
- [ ] Rust 依赖安装成功
- [ ] 数据库模块初始化完成
- [ ] 项目可以正常启动 (`npm run tauri dev`)

## 预期产出

1. 完整的前端基础架构
2. 可切换的深浅色主题
3. 基础布局框架
4. SQLite 数据库初始化
5. 项目可以正常编译运行
