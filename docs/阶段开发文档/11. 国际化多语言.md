# 11. 国际化多语言开发

## 需求描述
为应用添加中、英双语支持（后期可扩展更多语言），用户可在系统设置中切换语言，也支持跟随系统语言自动切换。

## 开发状态：已完成

### 完成情况

**已完成**：
- i18n 基础设施和配置 (vue-i18n, YAML 翻译文件)
- 系统设置中的语言切换功能（支持跟随系统/中文/English）
- 主要组件国际化：
  - Header.vue - 连接状态、按钮
  - Sidebar.vue - 服务器列表、订阅管理
  - SettingsDialog.vue - 系统设置对话框
  - PublishPanel.vue - 发布消息面板
  - MessageList.vue - 消息列表
  - ServerFormDialog.vue - 服务器配置表单
  - ScriptDialog.vue - 脚本管理（部分）
  - ScheduledPublishDialog.vue - 定时发布（部分）
  - TemplateDialog.vue - 模板编辑
  - TemplateDrawer.vue - 模板抽屉
  - CommandBar.vue - 快捷命令栏
  - App.vue - 根组件
- Rust 后端错误消息英文化

**待完善**：
- ScriptDialog 中的可用函数列表（技术文档，暂保持英文）
- ScheduledPublishDialog 中部分高级配置文本
- 代码注释（无需国际化）

## 技术方案

| 项目 | 选择 |
|------|------|
| i18n 库 | vue-i18n |
| 翻译文件格式 | YAML (.yaml) |
| 语言切换 | 在系统设置对话框添加，支持「跟随系统 / 中文 / English」三选项 |
| 默认策略 | 跟随系统语言，若不支持则回退英文 |
| 后端处理 | 后端返回英文消息，前端负责翻译显示 |

## 实现方案

### 前端实现

#### 1. 依赖安装

```bash
npm install vue-i18n
npm install -D @intlify/unplugin-vue-i18n js-yaml @types/js-yaml
```

#### 2. i18n 目录结构

```
src/i18n/
├── index.ts        # i18n 实例配置
├── locales/
│   ├── zh-CN.yaml  # 中文翻译
│   └── en-US.yaml  # 英文翻译
```

#### 3. 翻译文件结构

```yaml
# 示例结构
common:
  confirm: 确定
  cancel: 取消
  save: 保存
  delete: 删除
  edit: 编辑
  copy: 复制
  close: 关闭
  loading: 加载中...

header:
  welcome: 欢迎使用 Mini MQTT Client
  connect: 连接
  disconnect: 断开
  connecting: 连接中
  settings: 设置
  status:
    connected: 已连接
    connecting: 连接中...
    disconnected: 未连接
    error: 连接错误

sidebar:
  server: SERVER
  addServer: 添加 Server
  noServer: 暂无 Server
  subscription: 订阅
  addSubscription: 添加订阅
  editSubscription: 编辑订阅
  addSubscriptionHint: 点击 + 添加订阅
  colorMark: 颜色标记
  noColor: 无颜色
  actions:
    edit: 编辑
    duplicate: 复制
    delete: 删除
  theme:
    light: 浅色模式
    dark: 深色模式
    auto: 跟随系统

settings:
  title: 系统设置
  theme:
    title: 外观主题
    desc: 选择应用的外观主题，立即生效
    light: 浅色
    dark: 深色
    auto: 跟随系统
  language:
    title: 界面语言
    desc: 选择应用的界面语言
    zhCN: 中文
    enUS: English
    auto: 跟随系统
  storage:
    title: 数据存储
    desc: 配置和脚本等数据的存储位置
    changeLocation: 更改位置
    copyPath: 复制路径
    migrateAlert: 将迁移数据到新位置
  log:
    title: 日志
    desc: 错误日志按天分割，最多保留 10 个日志文件
    openDir: 打开日志目录
    clear: 清空日志
    clearConfirm: 确定要清空所有日志文件吗？此操作不可撤销。
  update:
    title: 检查更新
    currentVersion: 当前版本
    check: 检查更新
    newVersion: 发现新版本
    upToDate: 已是最新版本
    download: 前往下载

publish:
  topic: Topic
  payload: Payload
  qos: QoS
  retain: Retain
  send: 发送
  clear: 清空
  saveTemplate: 保存模板
  scheduledPublish: 定时发布
  payloadType: 格式

messages:
  title: 消息列表
  clear: 清空消息
  noMessages: 暂无消息
  direction:
    received: 接收
    sent: 发送
  clearConfirm: 确定要清空所有消息吗？

template:
  title: 命令模板
  save: 保存模板
  name: 模板名称
  category: 分类
  newCategory: 新建分类
  noTemplate: 暂无模板
  useTemplate: 使用模板
  deleteConfirm: 确定要删除此模板吗？

script:
  title: 预处理脚本
  name: 脚本名称
  type: 类型
  beforeSend: 发送前
  afterReceive: 接收后
  enabled: 启用
  testRun: 测试运行
  noScript: 暂无脚本

scheduled:
  title: 定时发布
  selectTemplate: 选择模板
  mode: 发布模式
  once: 单次
  interval: 间隔
  cron: Cron表达式
  intervalSeconds: 间隔（秒）
  start: 开始
  stop: 停止
  running: 运行中

server:
  addTitle: 添加服务器
  editTitle: 编辑服务器
  name: 名称
  host: 主机
  port: 端口
  clientId: Client ID
  protocol: 协议版本
  keepAlive: Keep Alive
  useTls: 使用 TLS
  cleanSession: Clean Session
  username: 用户名
  password: 密码
  advanced: 高级设置
  tls:
    title: TLS 设置
    caCert: CA 证书
    clientCert: 客户端证书
    clientKey: 客户端密钥
    keyPassword: 密钥密码

errors:
  connectFailed: 连接失败
  disconnectFailed: 断开失败
  publishFailed: 发布失败
  subscribeFailed: 订阅失败
  unsubscribeFailed: 取消订阅失败
  saveFailed: 保存失败
  deleteFailed: 删除失败
  loadFailed: 加载失败
  selectServer: 请先选择一个服务器
  inputTopic: 请输入 Topic
  inputPayload: 请输入 Payload
  inputName: 请输入名称
  hexInvalid: HEX 格式无效
  jsonInvalid: JSON 格式无效
  
success:
  connected: 连接成功
  disconnected: 已断开连接
  published: 发布成功
  subscribed: 订阅成功
  unsubscribed: 已取消订阅
  saved: 保存成功
  deleted: 删除成功
  copied: 已复制到剪贴板
  templateLoaded: 模板已加载
```

#### 4. 状态管理扩展 (`stores/app.ts`)

新增语言状态：
- `locale`: 语言设置 (`'auto' | 'zh-CN' | 'en-US'`)
- `setLocale()`: 切换语言方法
- `initLocale()`: 初始化语言（检测系统语言）
- `getActualLocale()`: 获取实际使用的语言

#### 5. 设置对话框更新 (`SettingsDialog.vue`)

在主题设置下方添加语言设置：
- 使用 el-radio-group 实现三选项切换
- UI 设计参考主题切换
- 立即生效

#### 6. Element Plus 国际化

```typescript
// main.ts
import ElementPlus from 'element-plus'
import zhCn from 'element-plus/es/locale/lang/zh-cn'
import en from 'element-plus/es/locale/lang/en'

// 根据语言设置动态切换
app.use(ElementPlus, { locale: currentLocale === 'zh-CN' ? zhCn : en })
```

### 后端实现

#### 1. 错误消息英文化

将 `src-tauri/src/` 中的中文错误消息改为英文：

| 原文 | 修改后 |
|------|--------|
| `无法打开日志文件` | `Failed to open log file` |
| `请提供绝对路径` | `Please provide an absolute path` |
| `无法创建目录` | `Failed to create directory` |
| `复制数据文件失败` | `Failed to copy data file` |
| `保存配置失败` | `Failed to save config` |
| `选择数据存储目录` | `Select Data Directory` |
| `无效的路径` | `Invalid path` |
| ... | ... |

#### 2. 对话框标题

将 Tauri 对话框标题改为英文（系统级对话框通常使用英文）。

### 组件国际化清单

需要国际化的组件：

**布局组件**：
- `Header.vue` - 连接状态、按钮文本
- `Sidebar.vue` - 服务器列表、订阅列表、主题切换
- `CommandBar.vue` - 操作按钮
- `AppLayout.vue` - 布局相关文本

**MQTT 组件**：
- `MainContent.vue` - 主内容区文本
- `MessageList.vue` - 消息列表、时间格式
- `MessagePayload.vue` - 消息格式切换
- `PublishPanel.vue` - 发布面板所有文本
- `ServerFormDialog.vue` - 服务器表单
- `ScheduledPublishDialog.vue` - 定时发布对话框

**模板组件**：
- `TemplateDrawer.vue` - 模板抽屉
- `TemplateDialog.vue` - 保存模板对话框
- `TemplateList.vue` - 模板列表
- `QuickSendPanel.vue` - 快速发送面板
- `TemplateManager.vue` - 模板管理

**其他组件**：
- `SettingsDialog.vue` - 系统设置
- `ScriptDialog.vue` - 脚本管理
- `App.vue` - 根组件提示

## 文件变更列表

### 新增文件
- `src/i18n/index.ts` - i18n 配置
- `src/i18n/locales/zh-CN.yaml` - 中文翻译
- `src/i18n/locales/en-US.yaml` - 英文翻译

### 修改文件
- `package.json` - 添加 vue-i18n 依赖
- `vite.config.ts` - 配置 YAML 加载
- `src/main.ts` - 注册 i18n 插件
- `src/stores/app.ts` - 添加语言状态管理
- `src/components/settings/SettingsDialog.vue` - 添加语言设置
- 所有包含中文文本的组件 - 替换为 $t() 调用
- `src-tauri/src/` 下的 Rust 文件 - 错误消息英文化

## 使用说明

1. 打开系统设置 -> 界面语言
2. 选择「跟随系统」「中文」或「English」
3. 切换后立即生效，设置会保存到本地存储
4. 时间格式会根据语言自动适配
