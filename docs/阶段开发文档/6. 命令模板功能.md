六：命令模板功能

## 目标

实现命令模板的CRUD功能，支持快速发送历史命令和常用命令模板。

## 任务清单

- [ ] 实现命令模板数据库操作
- [ ] 创建命令模板Pinia Store
- [ ] 开发模板管理组件
- [ ] 实现快速发送功能
- [ ] 添加模板导入导出

---

## 1. 命令模板数据库操作

### 文件：`src-tauri/src/db/template.rs`

```rust
use rusqlite::{params, Connection, Result};
use serde::{Deserialize, Serialize};
use chrono::{DateTime, Utc};

#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct CommandTemplate {
    pub id: Option<i64>,
    pub server_id: i64,
    pub name: String,
    pub topic: String,
    pub payload: String,
    pub payload_type: String,  // json, hex, text
    pub qos: u8,
    pub retain: bool,
    pub description: Option<String>,
    pub category: Option<String>,
    pub use_count: i64,
    pub last_used_at: Option<String>,
    pub created_at: Option<String>,
    pub updated_at: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct CreateTemplateRequest {
    pub server_id: i64,
    pub name: String,
    pub topic: String,
    pub payload: String,
    pub payload_type: String,
    pub qos: u8,
    pub retain: bool,
    pub description: Option<String>,
    pub category: Option<String>,
}

#[derive(Debug, Serialize, Deserialize)]
pub struct UpdateTemplateRequest {
    pub id: i64,
    pub name: Option<String>,
    pub topic: Option<String>,
    pub payload: Option<String>,
    pub payload_type: Option<String>,
    pub qos: Option<u8>,
    pub retain: Option<bool>,
    pub description: Option<String>,
    pub category: Option<String>,
}

pub fn create_template(conn: &Connection, req: CreateTemplateRequest) -> Result<i64> {
    conn.execute(
        "INSERT INTO command_templates (server_id, name, topic, payload, payload_type, qos, retain, description, category, use_count, created_at, updated_at)
         VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, 0, datetime('now'), datetime('now'))",
        params![
            req.server_id,
            req.name,
            req.topic,
            req.payload,
            req.payload_type,
            req.qos,
            req.retain,
            req.description,
            req.category,
        ],
    )?;
    Ok(conn.last_insert_rowid())
}

pub fn get_template(conn: &Connection, id: i64) -> Result<Option<CommandTemplate>> {
    let mut stmt = conn.prepare(
        "SELECT id, server_id, name, topic, payload, payload_type, qos, retain, description, category, use_count, last_used_at, created_at, updated_at
         FROM command_templates WHERE id = ?1"
    )?;
    
    let mut rows = stmt.query(params![id])?;
    
    if let Some(row) = rows.next()? {
        Ok(Some(CommandTemplate {
            id: Some(row.get(0)?),
            server_id: row.get(1)?,
            name: row.get(2)?,
            topic: row.get(3)?,
            payload: row.get(4)?,
            payload_type: row.get(5)?,
            qos: row.get(6)?,
            retain: row.get(7)?,
            description: row.get(8)?,
            category: row.get(9)?,
            use_count: row.get(10)?,
            last_used_at: row.get(11)?,
            created_at: row.get(12)?,
            updated_at: row.get(13)?,
        }))
    } else {
        Ok(None)
    }
}

pub fn list_templates_by_server(conn: &Connection, server_id: i64) -> Result<Vec<CommandTemplate>> {
    let mut stmt = conn.prepare(
        "SELECT id, server_id, name, topic, payload, payload_type, qos, retain, description, category, use_count, last_used_at, created_at, updated_at
         FROM command_templates WHERE server_id = ?1 ORDER BY use_count DESC, updated_at DESC"
    )?;
    
    let rows = stmt.query_map(params![server_id], |row| {
        Ok(CommandTemplate {
            id: Some(row.get(0)?),
            server_id: row.get(1)?,
            name: row.get(2)?,
            topic: row.get(3)?,
            payload: row.get(4)?,
            payload_type: row.get(5)?,
            qos: row.get(6)?,
            retain: row.get(7)?,
            description: row.get(8)?,
            category: row.get(9)?,
            use_count: row.get(10)?,
            last_used_at: row.get(11)?,
            created_at: row.get(12)?,
            updated_at: row.get(13)?,
        })
    })?;
    
    let mut templates = Vec::new();
    for template in rows {
        templates.push(template?);
    }
    Ok(templates)
}

pub fn list_templates_by_category(conn: &Connection, server_id: i64, category: &str) -> Result<Vec<CommandTemplate>> {
    let mut stmt = conn.prepare(
        "SELECT id, server_id, name, topic, payload, payload_type, qos, retain, description, category, use_count, last_used_at, created_at, updated_at
         FROM command_templates WHERE server_id = ?1 AND category = ?2 ORDER BY use_count DESC"
    )?;
    
    let rows = stmt.query_map(params![server_id, category], |row| {
        Ok(CommandTemplate {
            id: Some(row.get(0)?),
            server_id: row.get(1)?,
            name: row.get(2)?,
            topic: row.get(3)?,
            payload: row.get(4)?,
            payload_type: row.get(5)?,
            qos: row.get(6)?,
            retain: row.get(7)?,
            description: row.get(8)?,
            category: row.get(9)?,
            use_count: row.get(10)?,
            last_used_at: row.get(11)?,
            created_at: row.get(12)?,
            updated_at: row.get(13)?,
        })
    })?;
    
    let mut templates = Vec::new();
    for template in rows {
        templates.push(template?);
    }
    Ok(templates)
}

pub fn update_template(conn: &Connection, req: UpdateTemplateRequest) -> Result<()> {
    let mut updates = Vec::new();
    let mut params: Vec<Box<dyn rusqlite::ToSql>> = Vec::new();
    
    if let Some(name) = &req.name {
        updates.push("name = ?");
        params.push(Box::new(name.clone()));
    }
    if let Some(topic) = &req.topic {
        updates.push("topic = ?");
        params.push(Box::new(topic.clone()));
    }
    if let Some(payload) = &req.payload {
        updates.push("payload = ?");
        params.push(Box::new(payload.clone()));
    }
    if let Some(payload_type) = &req.payload_type {
        updates.push("payload_type = ?");
        params.push(Box::new(payload_type.clone()));
    }
    if let Some(qos) = req.qos {
        updates.push("qos = ?");
        params.push(Box::new(qos));
    }
    if let Some(retain) = req.retain {
        updates.push("retain = ?");
        params.push(Box::new(retain));
    }
    if let Some(description) = &req.description {
        updates.push("description = ?");
        params.push(Box::new(description.clone()));
    }
    if let Some(category) = &req.category {
        updates.push("category = ?");
        params.push(Box::new(category.clone()));
    }
    
    updates.push("updated_at = datetime('now')");
    params.push(Box::new(req.id));
    
    let sql = format!(
        "UPDATE command_templates SET {} WHERE id = ?",
        updates.join(", ")
    );
    
    let params_ref: Vec<&dyn rusqlite::ToSql> = params.iter().map(|p| p.as_ref()).collect();
    conn.execute(&sql, params_ref.as_slice())?;
    Ok(())
}

pub fn delete_template(conn: &Connection, id: i64) -> Result<()> {
    conn.execute("DELETE FROM command_templates WHERE id = ?1", params![id])?;
    Ok(())
}

pub fn increment_use_count(conn: &Connection, id: i64) -> Result<()> {
    conn.execute(
        "UPDATE command_templates SET use_count = use_count + 1, last_used_at = datetime('now') WHERE id = ?1",
        params![id],
    )?;
    Ok(())
}

pub fn get_categories(conn: &Connection, server_id: i64) -> Result<Vec<String>> {
    let mut stmt = conn.prepare(
        "SELECT DISTINCT category FROM command_templates WHERE server_id = ?1 AND category IS NOT NULL ORDER BY category"
    )?;
    
    let rows = stmt.query_map(params![server_id], |row| {
        row.get::<_, String>(0)
    })?;
    
    let mut categories = Vec::new();
    for category in rows {
        categories.push(category?);
    }
    Ok(categories)
}

pub fn search_templates(conn: &Connection, server_id: i64, keyword: &str) -> Result<Vec<CommandTemplate>> {
    let pattern = format!("%{}%", keyword);
    let mut stmt = conn.prepare(
        "SELECT id, server_id, name, topic, payload, payload_type, qos, retain, description, category, use_count, last_used_at, created_at, updated_at
         FROM command_templates 
         WHERE server_id = ?1 AND (name LIKE ?2 OR topic LIKE ?2 OR description LIKE ?2)
         ORDER BY use_count DESC"
    )?;
    
    let rows = stmt.query_map(params![server_id, pattern], |row| {
        Ok(CommandTemplate {
            id: Some(row.get(0)?),
            server_id: row.get(1)?,
            name: row.get(2)?,
            topic: row.get(3)?,
            payload: row.get(4)?,
            payload_type: row.get(5)?,
            qos: row.get(6)?,
            retain: row.get(7)?,
            description: row.get(8)?,
            category: row.get(9)?,
            use_count: row.get(10)?,
            last_used_at: row.get(11)?,
            created_at: row.get(12)?,
            updated_at: row.get(13)?,
        })
    })?;
    
    let mut templates = Vec::new();
    for template in rows {
        templates.push(template?);
    }
    Ok(templates)
}
```

---

## 2. Tauri命令

### 文件：`src-tauri/src/commands/template.rs`

```rust
use crate::db::{get_connection, template::*};
use tauri::command;

#[command]
pub async fn create_template(request: CreateTemplateRequest) -> Result<i64, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    create_template(&conn, request).map_err(|e| e.to_string())
}

#[command]
pub async fn get_template(id: i64) -> Result<Option<CommandTemplate>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    get_template(&conn, id).map_err(|e| e.to_string())
}

#[command]
pub async fn list_templates(server_id: i64) -> Result<Vec<CommandTemplate>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    list_templates_by_server(&conn, server_id).map_err(|e| e.to_string())
}

#[command]
pub async fn list_templates_by_category(server_id: i64, category: String) -> Result<Vec<CommandTemplate>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    list_templates_by_category(&conn, server_id, &category).map_err(|e| e.to_string())
}

#[command]
pub async fn update_template(request: UpdateTemplateRequest) -> Result<(), String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    update_template(&conn, request).map_err(|e| e.to_string())
}

#[command]
pub async fn delete_template(id: i64) -> Result<(), String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    delete_template(&conn, id).map_err(|e| e.to_string())
}

#[command]
pub async fn use_template(id: i64) -> Result<Option<CommandTemplate>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    
    // 增加使用次数
    increment_use_count(&conn, id).map_err(|e| e.to_string())?;
    
    // 返回模板详情
    get_template(&conn, id).map_err(|e| e.to_string())
}

#[command]
pub async fn get_template_categories(server_id: i64) -> Result<Vec<String>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    get_categories(&conn, server_id).map_err(|e| e.to_string())
}

#[command]
pub async fn search_templates(server_id: i64, keyword: String) -> Result<Vec<CommandTemplate>, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    search_templates(&conn, server_id, &keyword).map_err(|e| e.to_string())
}

#[command]
pub async fn export_templates(server_id: i64) -> Result<String, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    let templates = list_templates_by_server(&conn, server_id).map_err(|e| e.to_string())?;
    serde_json::to_string_pretty(&templates).map_err(|e| e.to_string())
}

#[command]
pub async fn import_templates(server_id: i64, json_data: String) -> Result<i32, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    
    let templates: Vec<CommandTemplate> = serde_json::from_str(&json_data)
        .map_err(|e| format!("JSON解析错误: {}", e))?;
    
    let mut imported = 0;
    for template in templates {
        let req = CreateTemplateRequest {
            server_id,
            name: template.name,
            topic: template.topic,
            payload: template.payload,
            payload_type: template.payload_type,
            qos: template.qos,
            retain: template.retain,
            description: template.description,
            category: template.category,
        };
        
        if create_template(&conn, req).is_ok() {
            imported += 1;
        }
    }
    
    Ok(imported)
}

#[command]
pub async fn duplicate_template(id: i64, new_name: String) -> Result<i64, String> {
    let conn = get_connection().map_err(|e| e.to_string())?;
    
    let template = get_template(&conn, id)
        .map_err(|e| e.to_string())?
        .ok_or("模板不存在")?;
    
    let req = CreateTemplateRequest {
        server_id: template.server_id,
        name: new_name,
        topic: template.topic,
        payload: template.payload,
        payload_type: template.payload_type,
        qos: template.qos,
        retain: template.retain,
        description: template.description,
        category: template.category,
    };
    
    create_template(&conn, req).map_err(|e| e.to_string())
}
```

---

## 3. 模板Store

### 文件：`src/stores/template.ts`

```typescript
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { invoke } from '@tauri-apps/api/core'

export interface CommandTemplate {
  id?: number
  server_id: number
  name: string
  topic: string
  payload: string
  payload_type: 'json' | 'hex' | 'text'
  qos: 0 | 1 | 2
  retain: boolean
  description?: string
  category?: string
  use_count: number
  last_used_at?: string
  created_at?: string
  updated_at?: string
}

export interface CreateTemplateRequest {
  server_id: number
  name: string
  topic: string
  payload: string
  payload_type: string
  qos: number
  retain: boolean
  description?: string
  category?: string
}

export interface UpdateTemplateRequest {
  id: number
  name?: string
  topic?: string
  payload?: string
  payload_type?: string
  qos?: number
  retain?: boolean
  description?: string
  category?: string
}

export const useTemplateStore = defineStore('template', () => {
  const templates = ref<CommandTemplate[]>([])
  const categories = ref<string[]>([])
  const loading = ref(false)
  const currentServerId = ref<number | null>(null)
  const selectedCategory = ref<string | null>(null)
  const searchKeyword = ref('')

  // 计算属性：按分类过滤的模板
  const filteredTemplates = computed(() => {
    let result = templates.value

    if (selectedCategory.value) {
      result = result.filter(t => t.category === selectedCategory.value)
    }

    if (searchKeyword.value) {
      const keyword = searchKeyword.value.toLowerCase()
      result = result.filter(t =>
        t.name.toLowerCase().includes(keyword) ||
        t.topic.toLowerCase().includes(keyword) ||
        (t.description?.toLowerCase().includes(keyword) ?? false)
      )
    }

    return result
  })

  // 计算属性：常用模板（前5个）
  const frequentTemplates = computed(() => {
    return [...templates.value]
      .sort((a, b) => b.use_count - a.use_count)
      .slice(0, 5)
  })

  // 计算属性：最近使用的模板
  const recentTemplates = computed(() => {
    return [...templates.value]
      .filter(t => t.last_used_at)
      .sort((a, b) => {
        const dateA = new Date(a.last_used_at!).getTime()
        const dateB = new Date(b.last_used_at!).getTime()
        return dateB - dateA
      })
      .slice(0, 10)
  })

  // 加载模板列表
  async function loadTemplates(serverId: number) {
    loading.value = true
    currentServerId.value = serverId
    try {
      templates.value = await invoke<CommandTemplate[]>('list_templates', { serverId })
      await loadCategories(serverId)
    } catch (error) {
      console.error('加载模板失败:', error)
      throw error
    } finally {
      loading.value = false
    }
  }

  // 加载分类列表
  async function loadCategories(serverId: number) {
    try {
      categories.value = await invoke<string[]>('get_template_categories', { serverId })
    } catch (error) {
      console.error('加载分类失败:', error)
    }
  }

  // 创建模板
  async function createTemplate(request: CreateTemplateRequest): Promise<number> {
    try {
      const id = await invoke<number>('create_template', { request })
      if (currentServerId.value === request.server_id) {
        await loadTemplates(request.server_id)
      }
      return id
    } catch (error) {
      console.error('创建模板失败:', error)
      throw error
    }
  }

  // 更新模板
  async function updateTemplate(request: UpdateTemplateRequest) {
    try {
      await invoke('update_template', { request })
      if (currentServerId.value) {
        await loadTemplates(currentServerId.value)
      }
    } catch (error) {
      console.error('更新模板失败:', error)
      throw error
    }
  }

  // 删除模板
  async function deleteTemplate(id: number) {
    try {
      await invoke('delete_template', { id })
      templates.value = templates.value.filter(t => t.id !== id)
    } catch (error) {
      console.error('删除模板失败:', error)
      throw error
    }
  }

  // 使用模板
  async function useTemplate(id: number): Promise<CommandTemplate> {
    try {
      const template = await invoke<CommandTemplate>('use_template', { id })
      // 更新本地使用次数
      const index = templates.value.findIndex(t => t.id === id)
      if (index !== -1) {
        templates.value[index].use_count++
        templates.value[index].last_used_at = new Date().toISOString()
      }
      return template
    } catch (error) {
      console.error('使用模板失败:', error)
      throw error
    }
  }

  // 搜索模板
  async function searchTemplates(serverId: number, keyword: string) {
    try {
      templates.value = await invoke<CommandTemplate[]>('search_templates', {
        serverId,
        keyword
      })
    } catch (error) {
      console.error('搜索模板失败:', error)
      throw error
    }
  }

  // 导出模板
  async function exportTemplates(serverId: number): Promise<string> {
    try {
      return await invoke<string>('export_templates', { serverId })
    } catch (error) {
      console.error('导出模板失败:', error)
      throw error
    }
  }

  // 导入模板
  async function importTemplates(serverId: number, jsonData: string): Promise<number> {
    try {
      const count = await invoke<number>('import_templates', { serverId, jsonData })
      await loadTemplates(serverId)
      return count
    } catch (error) {
      console.error('导入模板失败:', error)
      throw error
    }
  }

  // 复制模板
  async function duplicateTemplate(id: number, newName: string): Promise<number> {
    try {
      const newId = await invoke<number>('duplicate_template', { id, newName })
      if (currentServerId.value) {
        await loadTemplates(currentServerId.value)
      }
      return newId
    } catch (error) {
      console.error('复制模板失败:', error)
      throw error
    }
  }

  // 设置筛选分类
  function setCategory(category: string | null) {
    selectedCategory.value = category
  }

  // 设置搜索关键词
  function setSearchKeyword(keyword: string) {
    searchKeyword.value = keyword
  }

  // 清空筛选
  function clearFilters() {
    selectedCategory.value = null
    searchKeyword.value = ''
  }

  return {
    templates,
    categories,
    loading,
    currentServerId,
    selectedCategory,
    searchKeyword,
    filteredTemplates,
    frequentTemplates,
    recentTemplates,
    loadTemplates,
    loadCategories,
    createTemplate,
    updateTemplate,
    deleteTemplate,
    useTemplate,
    searchTemplates,
    exportTemplates,
    importTemplates,
    duplicateTemplate,
    setCategory,
    setSearchKeyword,
    clearFilters
  }
})
```

---

## 4. 模板列表组件

### 文件：`src/components/template/TemplateList.vue`

```vue
<template>
  <div class="template-list">
    <!-- 工具栏 -->
    <div class="template-toolbar">
      <el-input
        v-model="searchKeyword"
        placeholder="搜索模板..."
        prefix-icon="Search"
        clearable
        @input="handleSearch"
      />
      <el-select
        v-model="selectedCategory"
        placeholder="全部分类"
        clearable
        @change="handleCategoryChange"
      >
        <el-option
          v-for="category in categories"
          :key="category"
          :label="category"
          :value="category"
        />
      </el-select>
      <el-button type="primary" @click="showCreateDialog = true">
        新建模板
      </el-button>
      <el-dropdown @command="handleCommand">
        <el-button>
          更多操作
          <el-icon class="el-icon--right"><ArrowDown /></el-icon>
        </el-button>
        <template #dropdown>
          <el-dropdown-menu>
            <el-dropdown-item command="import">导入模板</el-dropdown-item>
            <el-dropdown-item command="export">导出模板</el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
    </div>

    <!-- 快速访问：常用模板 -->
    <div v-if="frequentTemplates.length > 0" class="template-section">
      <h4>常用模板</h4>
      <div class="template-quick-list">
        <el-tag
          v-for="template in frequentTemplates"
          :key="template.id"
          class="quick-template"
          @click="handleQuickUse(template)"
        >
          {{ template.name }}
          <span class="use-count">({{ template.use_count }})</span>
        </el-tag>
      </div>
    </div>

    <!-- 模板列表 -->
    <div class="template-content">
      <el-table
        :data="filteredTemplates"
        v-loading="loading"
        stripe
        @row-dblclick="handleQuickUse"
      >
        <el-table-column prop="name" label="名称" min-width="120" />
        <el-table-column prop="topic" label="主题" min-width="150" show-overflow-tooltip />
        <el-table-column prop="payload_type" label="类型" width="80">
          <template #default="{ row }">
            <el-tag size="small" :type="getPayloadTypeTag(row.payload_type)">
              {{ row.payload_type.toUpperCase() }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="qos" label="QoS" width="60" />
        <el-table-column prop="retain" label="Retain" width="70">
          <template #default="{ row }">
            <el-tag :type="row.retain ? 'success' : 'info'" size="small">
              {{ row.retain ? '是' : '否' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="category" label="分类" width="100" />
        <el-table-column prop="use_count" label="使用次数" width="90" />
        <el-table-column label="操作" width="200" fixed="right">
          <template #default="{ row }">
            <el-button-group>
              <el-button size="small" type="primary" @click="handleQuickUse(row)">
                发送
              </el-button>
              <el-button size="small" @click="handleEdit(row)">
                编辑
              </el-button>
              <el-button size="small" @click="handleDuplicate(row)">
                复制
              </el-button>
              <el-button size="small" type="danger" @click="handleDelete(row)">
                删除
              </el-button>
            </el-button-group>
          </template>
        </el-table-column>
      </el-table>
    </div>

    <!-- 创建/编辑对话框 -->
    <TemplateDialog
      v-model:visible="showCreateDialog"
      :template="editingTemplate"
      :server-id="serverId"
      @saved="handleSaved"
    />

    <!-- 导入对话框 -->
    <el-dialog v-model="showImportDialog" title="导入模板" width="500px">
      <el-upload
        ref="uploadRef"
        :auto-upload="false"
        :limit="1"
        accept=".json"
        @change="handleFileChange"
      >
        <template #trigger>
          <el-button>选择JSON文件</el-button>
        </template>
        <template #tip>
          <div class="el-upload__tip">
            请选择导出的JSON模板文件
          </div>
        </template>
      </el-upload>
      <template #footer>
        <el-button @click="showImportDialog = false">取消</el-button>
        <el-button type="primary" @click="handleImport" :loading="importing">
          导入
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { ArrowDown } from '@element-plus/icons-vue'
import { save } from '@tauri-apps/plugin-dialog'
import { writeTextFile } from '@tauri-apps/plugin-fs'
import { useTemplateStore, type CommandTemplate } from '@/stores/template'
import TemplateDialog from './TemplateDialog.vue'

const props = defineProps<{
  serverId: number
}>()

const emit = defineEmits<{
  use: [template: CommandTemplate]
}>()

const templateStore = useTemplateStore()

const searchKeyword = ref('')
const selectedCategory = ref<string | null>(null)
const showCreateDialog = ref(false)
const showImportDialog = ref(false)
const editingTemplate = ref<CommandTemplate | null>(null)
const importFileContent = ref('')
const importing = ref(false)

const loading = computed(() => templateStore.loading)
const filteredTemplates = computed(() => templateStore.filteredTemplates)
const frequentTemplates = computed(() => templateStore.frequentTemplates)
const categories = computed(() => templateStore.categories)

onMounted(() => {
  templateStore.loadTemplates(props.serverId)
})

function getPayloadTypeTag(type: string) {
  switch (type) {
    case 'json': return 'primary'
    case 'hex': return 'warning'
    default: return 'info'
  }
}

function handleSearch() {
  templateStore.setSearchKeyword(searchKeyword.value)
}

function handleCategoryChange() {
  templateStore.setCategory(selectedCategory.value)
}

async function handleQuickUse(template: CommandTemplate) {
  try {
    const used = await templateStore.useTemplate(template.id!)
    emit('use', used)
    ElMessage.success('已加载模板')
  } catch (error) {
    ElMessage.error('加载模板失败')
  }
}

function handleEdit(template: CommandTemplate) {
  editingTemplate.value = template
  showCreateDialog.value = true
}

async function handleDuplicate(template: CommandTemplate) {
  try {
    const { value: newName } = await ElMessageBox.prompt(
      '请输入新模板名称',
      '复制模板',
      {
        inputValue: `${template.name} - 副本`,
        inputPattern: /\S+/,
        inputErrorMessage: '名称不能为空'
      }
    )
    await templateStore.duplicateTemplate(template.id!, newName)
    ElMessage.success('模板已复制')
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('复制模板失败')
    }
  }
}

async function handleDelete(template: CommandTemplate) {
  try {
    await ElMessageBox.confirm(
      `确定要删除模板 "${template.name}" 吗？`,
      '删除确认',
      { type: 'warning' }
    )
    await templateStore.deleteTemplate(template.id!)
    ElMessage.success('模板已删除')
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('删除模板失败')
    }
  }
}

function handleSaved() {
  showCreateDialog.value = false
  editingTemplate.value = null
  ElMessage.success('模板已保存')
}

function handleCommand(command: string) {
  if (command === 'import') {
    showImportDialog.value = true
  } else if (command === 'export') {
    handleExport()
  }
}

async function handleExport() {
  try {
    const json = await templateStore.exportTemplates(props.serverId)
    const path = await save({
      filters: [{ name: 'JSON', extensions: ['json'] }],
      defaultPath: 'templates.json'
    })
    
    if (path) {
      await writeTextFile(path, json)
      ElMessage.success('模板已导出')
    }
  } catch (error) {
    ElMessage.error('导出失败')
  }
}

function handleFileChange(file: any) {
  const reader = new FileReader()
  reader.onload = (e) => {
    importFileContent.value = e.target?.result as string
  }
  reader.readAsText(file.raw)
}

async function handleImport() {
  if (!importFileContent.value) {
    ElMessage.warning('请先选择文件')
    return
  }
  
  importing.value = true
  try {
    const count = await templateStore.importTemplates(props.serverId, importFileContent.value)
    ElMessage.success(`成功导入 ${count} 个模板`)
    showImportDialog.value = false
    importFileContent.value = ''
  } catch (error) {
    ElMessage.error('导入失败: ' + error)
  } finally {
    importing.value = false
  }
}
</script>
```

---

## 5. 模板编辑对话框

### 文件：`src/components/template/TemplateDialog.vue`

```vue
<template>
  <el-dialog
    :model-value="visible"
    :title="isEdit ? '编辑模板' : '新建模板'"
    width="600px"
    @update:model-value="$emit('update:visible', $event)"
  >
    <el-form
      ref="formRef"
      :model="form"
      :rules="rules"
      label-width="100px"
    >
      <el-form-item label="模板名称" prop="name">
        <el-input v-model="form.name" placeholder="请输入模板名称" />
      </el-form-item>

      <el-form-item label="分类" prop="category">
        <el-select
          v-model="form.category"
          placeholder="选择或输入分类"
          filterable
          allow-create
          default-first-option
        >
          <el-option
            v-for="cat in categories"
            :key="cat"
            :label="cat"
            :value="cat"
          />
        </el-select>
      </el-form-item>

      <el-form-item label="主题" prop="topic">
        <el-input v-model="form.topic" placeholder="请输入MQTT主题" />
      </el-form-item>

      <el-form-item label="消息类型" prop="payload_type">
        <el-radio-group v-model="form.payload_type">
          <el-radio value="json">JSON</el-radio>
          <el-radio value="text">纯文本</el-radio>
          <el-radio value="hex">HEX</el-radio>
        </el-radio-group>
      </el-form-item>

      <el-form-item label="消息内容" prop="payload">
        <el-input
          v-model="form.payload"
          type="textarea"
          :rows="6"
          placeholder="请输入消息内容"
          :class="{ 'json-input': form.payload_type === 'json' }"
        />
        <div v-if="form.payload_type === 'json'" class="format-hint">
          <el-button size="small" text @click="formatJson">
            格式化JSON
          </el-button>
          <span v-if="jsonError" class="error-hint">{{ jsonError }}</span>
        </div>
      </el-form-item>

      <el-form-item label="QoS" prop="qos">
        <el-radio-group v-model="form.qos">
          <el-radio :value="0">QoS 0</el-radio>
          <el-radio :value="1">QoS 1</el-radio>
          <el-radio :value="2">QoS 2</el-radio>
        </el-radio-group>
      </el-form-item>

      <el-form-item label="Retain" prop="retain">
        <el-switch v-model="form.retain" />
        <span class="form-hint">保留消息</span>
      </el-form-item>

      <el-form-item label="描述" prop="description">
        <el-input
          v-model="form.description"
          type="textarea"
          :rows="2"
          placeholder="可选：模板描述"
        />
      </el-form-item>
    </el-form>

    <template #footer>
      <el-button @click="$emit('update:visible', false)">取消</el-button>
      <el-button type="primary" @click="handleSubmit" :loading="submitting">
        保存
      </el-button>
    </template>
  </el-dialog>
</template>

<script setup lang="ts">
import { ref, computed, watch } from 'vue'
import type { FormInstance, FormRules } from 'element-plus'
import { ElMessage } from 'element-plus'
import { useTemplateStore, type CommandTemplate } from '@/stores/template'

const props = defineProps<{
  visible: boolean
  template: CommandTemplate | null
  serverId: number
}>()

const emit = defineEmits<{
  'update:visible': [value: boolean]
  saved: []
}>()

const templateStore = useTemplateStore()
const formRef = ref<FormInstance>()
const submitting = ref(false)
const jsonError = ref('')

const isEdit = computed(() => !!props.template?.id)
const categories = computed(() => templateStore.categories)

const form = ref({
  name: '',
  category: '',
  topic: '',
  payload_type: 'json' as 'json' | 'text' | 'hex',
  payload: '',
  qos: 0 as 0 | 1 | 2,
  retain: false,
  description: ''
})

const rules: FormRules = {
  name: [
    { required: true, message: '请输入模板名称', trigger: 'blur' }
  ],
  topic: [
    { required: true, message: '请输入MQTT主题', trigger: 'blur' }
  ],
  payload: [
    { required: true, message: '请输入消息内容', trigger: 'blur' }
  ]
}

// 监听template变化，填充表单
watch(() => props.template, (template) => {
  if (template) {
    form.value = {
      name: template.name,
      category: template.category || '',
      topic: template.topic,
      payload_type: template.payload_type,
      payload: template.payload,
      qos: template.qos,
      retain: template.retain,
      description: template.description || ''
    }
  } else {
    resetForm()
  }
}, { immediate: true })

// 监听visible，重置表单
watch(() => props.visible, (visible) => {
  if (visible && !props.template) {
    resetForm()
  }
  jsonError.value = ''
})

function resetForm() {
  form.value = {
    name: '',
    category: '',
    topic: '',
    payload_type: 'json',
    payload: '',
    qos: 0,
    retain: false,
    description: ''
  }
  formRef.value?.resetFields()
}

function formatJson() {
  try {
    const parsed = JSON.parse(form.value.payload)
    form.value.payload = JSON.stringify(parsed, null, 2)
    jsonError.value = ''
  } catch (e) {
    jsonError.value = 'JSON格式错误'
  }
}

async function handleSubmit() {
  if (!formRef.value) return
  
  const valid = await formRef.value.validate().catch(() => false)
  if (!valid) return

  // JSON格式验证
  if (form.value.payload_type === 'json') {
    try {
      JSON.parse(form.value.payload)
    } catch (e) {
      jsonError.value = 'JSON格式错误，请检查'
      return
    }
  }

  submitting.value = true
  try {
    if (isEdit.value) {
      await templateStore.updateTemplate({
        id: props.template!.id!,
        name: form.value.name,
        category: form.value.category || undefined,
        topic: form.value.topic,
        payload_type: form.value.payload_type,
        payload: form.value.payload,
        qos: form.value.qos,
        retain: form.value.retain,
        description: form.value.description || undefined
      })
    } else {
      await templateStore.createTemplate({
        server_id: props.serverId,
        name: form.value.name,
        topic: form.value.topic,
        payload: form.value.payload,
        payload_type: form.value.payload_type,
        qos: form.value.qos,
        retain: form.value.retain,
        category: form.value.category || undefined,
        description: form.value.description || undefined
      })
    }
    emit('saved')
  } catch (error) {
    ElMessage.error('保存失败: ' + error)
  } finally {
    submitting.value = false
  }
}
</script>

```

---

## 6. 快速发送面板

### 文件：`src/components/template/QuickSendPanel.vue`

```vue
<template>
  <div class="quick-send-panel">
    <div class="panel-header">
      <h4>快速发送</h4>
      <el-button text size="small" @click="$emit('manage')">
        管理模板
      </el-button>
    </div>

    <!-- 搜索 -->
    <el-input
      v-model="searchKeyword"
      placeholder="搜索模板..."
      prefix-icon="Search"
      clearable
      size="small"
    />

    <!-- 分类标签 -->
    <div class="category-tabs">
      <el-tag
        :type="!selectedCategory ? 'primary' : 'info'"
        class="category-tag"
        @click="selectedCategory = null"
      >
        全部
      </el-tag>
      <el-tag
        v-for="cat in categories"
        :key="cat"
        :type="selectedCategory === cat ? 'primary' : 'info'"
        class="category-tag"
        @click="selectedCategory = cat"
      >
        {{ cat }}
      </el-tag>
    </div>

    <!-- 模板列表 -->
    <div class="template-list">
      <div
        v-for="template in displayedTemplates"
        :key="template.id"
        class="template-item"
        @click="handleSend(template)"
      >
        <div class="template-info">
          <span class="template-name">{{ template.name }}</span>
          <span class="template-topic">{{ template.topic }}</span>
        </div>
        <div class="template-meta">
          <el-tag size="small" :type="getPayloadTypeTag(template.payload_type)">
            {{ template.payload_type }}
          </el-tag>
          <span class="use-count">{{ template.use_count }}次</span>
        </div>
      </div>

      <el-empty
        v-if="displayedTemplates.length === 0"
        description="暂无模板"
        :image-size="60"
      />
    </div>

    <!-- 最近使用 -->
    <div v-if="recentTemplates.length > 0" class="recent-section">
      <h5>最近使用</h5>
      <div class="recent-list">
        <el-tag
          v-for="template in recentTemplates"
          :key="template.id"
          class="recent-item"
          @click="handleSend(template)"
        >
          {{ template.name }}
        </el-tag>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { useTemplateStore, type CommandTemplate } from '@/stores/template'

const props = defineProps<{
  serverId: number
}>()

const emit = defineEmits<{
  send: [template: CommandTemplate]
  manage: []
}>()

const templateStore = useTemplateStore()

const searchKeyword = ref('')
const selectedCategory = ref<string | null>(null)

const categories = computed(() => templateStore.categories)

const displayedTemplates = computed(() => {
  let result = templateStore.templates

  if (selectedCategory.value) {
    result = result.filter(t => t.category === selectedCategory.value)
  }

  if (searchKeyword.value) {
    const keyword = searchKeyword.value.toLowerCase()
    result = result.filter(t =>
      t.name.toLowerCase().includes(keyword) ||
      t.topic.toLowerCase().includes(keyword)
    )
  }

  return result.slice(0, 20) // 限制显示数量
})

const recentTemplates = computed(() => templateStore.recentTemplates.slice(0, 5))

onMounted(() => {
  templateStore.loadTemplates(props.serverId)
})

function getPayloadTypeTag(type: string) {
  switch (type) {
    case 'json': return 'primary'
    case 'hex': return 'warning'
    default: return 'info'
  }
}

async function handleSend(template: CommandTemplate) {
  try {
    const used = await templateStore.useTemplate(template.id!)
    emit('send', used)
  } catch (error) {
    ElMessage.error('加载模板失败')
  }
}
</script>

```

---

## 验收标准

1. 模板CRUD功能正常
2. 模板分类管理正常
3. 搜索功能正常
4. 快速发送功能正常
5. 使用次数统计正常
6. 模板导入导出正常
7. 模板复制功能正常

## 下一阶段

完成后进入[阶段七：优化与完善](./阶段七-优化与完善.md)
