# 阶段八：定时发布功能

## 概述

本阶段实现定时循环发布命令的功能，允许用户选择多条保存的命令模板，按照设定的间隔和顺序循环发送。

## 功能需求

### 8.1 功能入口

- 在发布面板或工具栏添加"定时发布"按钮
- 点击按钮弹出定时发布配置对话框

### 8.2 命令选择

- 弹框列表展示已保存的命令模板
- 支持勾选多条命令
- 显示命令的 Topic、Payload 预览、QoS 等信息
- 支持全选/取消全选

### 8.3 发送配置

- 设置发送间隔（毫秒/秒）
- 设置发送顺序（按勾选顺序/按名称排序）
- 设置循环次数（无限循环/指定次数）
- 设置每轮间隔（可选）

### 8.4 执行控制

- 开始/停止定时发布
- 显示当前发送进度和状态
- 显示已发送次数统计

---

## UI 设计

### 8.1 定时发布按钮

**位置：** 发布面板标题栏右侧

```
┌─────────────────────────────────────────────────────────────┐
│  [发布图标] 发布消息                    [JSON ▼] [定时发布] │
├─────────────────────────────────────────────────────────────┤
│  ...                                                        │
```

### 8.2 定时发布对话框

**尺寸：** 700px x 600px

```
┌─────────────────────────────────────────────────────────────┐
│  定时发布                                              [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ 命令列表 ──────────────────────────────────────────┐   │
│  │  [全选] 已选择 3 条命令                             │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  [✓] 命令1                                          │   │
│  │      Topic: device/001/command                      │   │
│  │      Payload: {"action":"start"} │ QoS: 1           │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  [✓] 命令2                                          │   │
│  │      Topic: device/001/status                       │   │
│  │      Payload: {"query":"all"} │ QoS: 0              │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  [ ] 命令3                                          │   │
│  │      Topic: device/002/command                      │   │
│  │      Payload: {"action":"stop"} │ QoS: 1            │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  [✓] 命令4                                          │   │
│  │      Topic: system/heartbeat                        │   │
│  │      Payload: {} │ QoS: 0                           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 发送配置 ──────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  发送间隔:  [1000    ] ms    命令间隔时间           │   │
│  │                                                     │   │
│  │  发送顺序:  (●) 按勾选顺序  ( ) 按名称排序          │   │
│  │                                                     │   │
│  │  循环模式:  (●) 无限循环    ( ) 指定次数 [10  ]     │   │
│  │                                                     │   │
│  │  每轮间隔:  [0       ] ms    每轮循环之间的间隔     │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                          [取消]  [开始发布]                 │
└─────────────────────────────────────────────────────────────┘
```

### 8.3 发送中状态

当定时发布开始后，对话框变为发送状态视图：

```
┌─────────────────────────────────────────────────────────────┐
│  定时发布 - 运行中                                     [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─ 发送状态 ──────────────────────────────────────────┐   │
│  │                                                     │   │
│  │     ●  正在发送...                                  │   │
│  │                                                     │   │
│  │     当前命令:  device/001/command                   │   │
│  │     当前轮次:  第 5 轮                              │   │
│  │     已发送:    15 条消息                            │   │
│  │     成功/失败: 15 / 0                               │   │
│  │                                                     │   │
│  │     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━             │   │
│  │     命令 2/3  |  进度 50%                           │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 发送日志 ──────────────────────────────────────────┐   │
│  │  [12:30:01] 发送: device/001/command - 成功         │   │
│  │  [12:30:02] 发送: device/001/status - 成功          │   │
│  │  [12:30:03] 发送: system/heartbeat - 成功           │   │
│  │  [12:30:04] 发送: device/001/command - 成功         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                          [停止发布]                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 任务清单

### 8.1 前端组件

- [ ] 创建 ScheduledPublishDialog.vue 组件
- [ ] 实现命令列表展示和勾选
- [ ] 实现发送配置表单
- [ ] 实现发送状态视图
- [ ] 实现发送日志展示

### 8.2 发送逻辑

- [ ] 实现定时发送循环（使用 setInterval）
- [ ] 实现发送队列管理
- [ ] 实现开始/停止控制
- [ ] 实现发送统计

### 8.3 状态管理

- [ ] 创建 scheduledPublish store
- [ ] 存储发送配置
- [ ] 存储发送状态

### 8.4 后端支持（可选）

- [ ] 保存定时发布配置到文件
- [ ] 历史配置加载

---

## 详细实现

### 8.1 组件结构

**文件：`src/components/mqtt/ScheduledPublishDialog.vue`**

```vue
<template>
  <el-dialog
    v-model="visible"
    :title="isRunning ? '定时发布 - 运行中' : '定时发布'"
    width="700px"
    :close-on-click-modal="false"
  >
    <!-- 配置视图 -->
    <div v-if="!isRunning" class="config-view">
      <!-- 命令列表 -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">命令列表</span>
          <div class="section-actions">
            <el-checkbox
              v-model="selectAll"
              :indeterminate="isIndeterminate"
              @change="handleSelectAll"
            >
              全选
            </el-checkbox>
            <span class="selected-count">已选择 {{ selectedCount }} 条命令</span>
          </div>
        </div>
        <div class="command-list">
          <div
            v-for="cmd in commands"
            :key="cmd.id"
            class="command-item"
            :class="{ selected: selectedIds.includes(cmd.id) }"
          >
            <el-checkbox
              v-model="selectedIds"
              :value="cmd.id"
            />
            <div class="command-info">
              <div class="command-name">{{ cmd.name }}</div>
              <div class="command-meta">
                <span class="topic">Topic: {{ cmd.topic }}</span>
                <span class="payload">{{ truncatePayload(cmd.payload) }}</span>
                <el-tag size="small">QoS {{ cmd.qos }}</el-tag>
              </div>
            </div>
          </div>
          <div v-if="commands.length === 0" class="empty-state">
            <el-empty description="暂无保存的命令模板" />
          </div>
        </div>
      </div>

      <!-- 发送配置 -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">发送配置</span>
        </div>
        <el-form :model="config" label-width="100px">
          <el-form-item label="发送间隔">
            <el-input-number
              v-model="config.interval"
              :min="100"
              :max="60000"
              :step="100"
            />
            <span class="unit">ms</span>
            <span class="hint">命令之间的间隔时间</span>
          </el-form-item>
          <el-form-item label="发送顺序">
            <el-radio-group v-model="config.order">
              <el-radio value="selection">按勾选顺序</el-radio>
              <el-radio value="name">按名称排序</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item label="循环模式">
            <el-radio-group v-model="config.loopMode">
              <el-radio value="infinite">无限循环</el-radio>
              <el-radio value="count">指定次数</el-radio>
            </el-radio-group>
            <el-input-number
              v-if="config.loopMode === 'count'"
              v-model="config.loopCount"
              :min="1"
              :max="9999"
              style="margin-left: 12px"
            />
          </el-form-item>
          <el-form-item label="每轮间隔">
            <el-input-number
              v-model="config.roundInterval"
              :min="0"
              :max="60000"
              :step="100"
            />
            <span class="unit">ms</span>
            <span class="hint">每轮循环之间的额外间隔</span>
          </el-form-item>
        </el-form>
      </div>
    </div>

    <!-- 运行视图 -->
    <div v-else class="running-view">
      <!-- 发送状态 -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">发送状态</span>
        </div>
        <div class="status-panel">
          <div class="status-indicator running">
            <el-icon class="spinning"><Loading /></el-icon>
            正在发送...
          </div>
          <div class="status-info">
            <div class="info-row">
              <span class="label">当前命令:</span>
              <span class="value">{{ currentCommand?.topic }}</span>
            </div>
            <div class="info-row">
              <span class="label">当前轮次:</span>
              <span class="value">第 {{ currentRound }} 轮</span>
            </div>
            <div class="info-row">
              <span class="label">已发送:</span>
              <span class="value">{{ sentCount }} 条消息</span>
            </div>
            <div class="info-row">
              <span class="label">成功/失败:</span>
              <span class="value success">{{ successCount }}</span>
              <span> / </span>
              <span class="value error">{{ failCount }}</span>
            </div>
          </div>
          <el-progress
            :percentage="progressPercentage"
            :format="formatProgress"
          />
        </div>
      </div>

      <!-- 发送日志 -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">发送日志</span>
        </div>
        <div class="log-list" ref="logListRef">
          <div
            v-for="(log, index) in logs"
            :key="index"
            class="log-item"
            :class="log.status"
          >
            <span class="log-time">[{{ log.time }}]</span>
            <span class="log-topic">{{ log.topic }}</span>
            <el-tag :type="log.status === 'success' ? 'success' : 'danger'" size="small">
              {{ log.status === 'success' ? '成功' : '失败' }}
            </el-tag>
          </div>
        </div>
      </div>
    </div>

    <template #footer>
      <el-button v-if="!isRunning" @click="handleClose">取消</el-button>
      <el-button
        v-if="!isRunning"
        type="primary"
        :disabled="selectedIds.length === 0"
        @click="handleStart"
      >
        开始发布
      </el-button>
      <el-button v-else type="danger" @click="handleStop">
        停止发布
      </el-button>
    </template>
  </el-dialog>
</template>
```

### 8.2 发送逻辑

```typescript
// 开始定时发布
async function startPublishing() {
  isRunning.value = true;
  currentIndex.value = 0;
  currentRound.value = 1;
  sentCount.value = 0;
  successCount.value = 0;
  failCount.value = 0;
  logs.value = [];

  // 获取要发送的命令列表
  const commandsToSend = getOrderedCommands();

  // 开始发送循环
  publishInterval = setInterval(async () => {
    if (!isRunning.value) {
      clearInterval(publishInterval);
      return;
    }

    const command = commandsToSend[currentIndex.value];
    currentCommand.value = command;

    try {
      await mqttStore.publish(
        serverId,
        command.topic,
        command.payload,
        command.qos,
        command.retain
      );
      successCount.value++;
      addLog(command.topic, 'success');
    } catch (error) {
      failCount.value++;
      addLog(command.topic, 'error', error.message);
    }

    sentCount.value++;
    currentIndex.value++;

    // 检查是否完成一轮
    if (currentIndex.value >= commandsToSend.length) {
      currentIndex.value = 0;
      currentRound.value++;

      // 检查是否达到循环次数
      if (config.loopMode === 'count' && currentRound.value > config.loopCount) {
        stopPublishing();
        ElMessage.success('定时发布完成');
        return;
      }

      // 添加每轮间隔
      if (config.roundInterval > 0) {
        clearInterval(publishInterval);
        setTimeout(() => {
          if (isRunning.value) {
            startPublishLoop();
          }
        }, config.roundInterval);
      }
    }
  }, config.interval);
}

// 停止定时发布
function stopPublishing() {
  isRunning.value = false;
  if (publishInterval) {
    clearInterval(publishInterval);
    publishInterval = null;
  }
}
```

---

## 样式设计

### 配色方案

- 主色调：使用项目主色 `--primary-color`
- 运行状态：绿色 `--status-connected`
- 停止状态：红色 `--status-error`
- 背景色：使用 `--sidebar-bg`

### 交互效果

- 命令项 hover 高亮
- 选中命令项边框强调
- 运行中图标旋转动画
- 日志列表自动滚动到底部

---

## 测试要点

1. **命令选择测试**
   - 单选/多选功能正常
   - 全选/取消全选功能正常
   - 空列表提示正确

2. **配置验证测试**
   - 间隔时间范围验证
   - 循环次数范围验证
   - 配置参数正确传递

3. **发送功能测试**
   - 按配置间隔发送
   - 发送顺序正确
   - 循环次数正确
   - 成功/失败统计准确

4. **控制功能测试**
   - 开始/停止功能正常
   - 停止后可重新开始
   - 关闭对话框自动停止

---

## 完成标准

- [ ] 命令列表正确展示
- [ ] 多选功能正常工作
- [ ] 发送配置可自定义
- [ ] 定时发送逻辑正确
- [ ] 发送状态实时更新
- [ ] 日志记录正确
- [ ] 停止功能可靠
