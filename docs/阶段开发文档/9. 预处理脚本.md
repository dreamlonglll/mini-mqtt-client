# 9. 预处理脚本

## 功能概述
系统需要支持接入 JavaScript 脚本，并提供脚本执行环境。脚本分为两类：
- 发送前处理：在消息发布前对 payload 进行处理
- 接收后处理：在收到消息后对 payload 进行处理

## 功能需求

### 9.1 脚本管理
- 脚本按服务器配置，每个服务器独立管理脚本
- 提供脚本管理入口（在命令栏"管理模板"右侧添加"管理脚本"按钮）
- 脚本管理弹窗包含：
  - 左侧：脚本列表（支持启用/禁用开关）
  - 右侧：脚本编辑区（名称、类型、描述、代码）

### 9.2 脚本类型
1. **发送前处理（before_publish）**
   - 在发布消息时，对待发送的 payload 进行处理
   - 函数签名：`process(payload) -> payload`
   - 应用场景：数据格式化、加密、添加前缀等

2. **接收后处理（after_receive）**
   - 在收到消息后，对收到的 payload 进行处理
   - 函数签名：`process(payload, topic) -> payload`
   - 应用场景：数据解析、解密、格式化展示等

### 9.3 脚本执行引擎
- 使用 JavaScript 沙箱环境执行脚本
- 提供安全的执行上下文，限制访问范围
- 支持基础 API：JSON、String、Number、Array、Object、Date、Math 等
- 支持编码函数：btoa、atob、encodeURIComponent、decodeURIComponent
- 支持 console 输出（用于调试）

### 9.4 脚本模板
创建脚本时提供默认模板代码：

**发送前处理模板：**
```javascript
// 发送前处理脚本
// payload: 待发送的消息内容 (字符串)
// 返回值: 处理后的消息内容 (字符串)

function process(payload) {
  // 在这里处理 payload
  return payload;
}
```

**接收后处理模板：**
```javascript
// 接收后处理脚本
// payload: 接收到的消息内容 (字符串)
// topic: 消息主题 (字符串)
// 返回值: 处理后的消息内容 (字符串)

function process(payload, topic) {
  // 在这里处理接收到的消息
  return payload;
}
```

## 技术实现

### 后端 (Rust)
- 数据模型：Script（id, server_id, name, script_type, code, enabled, description）
- 存储：使用 YAML 文件存储脚本配置
- API：list_scripts, get_script, get_enabled_scripts, create_script, update_script, delete_script, toggle_script

### 前端 (Vue)
- ScriptDialog.vue：脚本管理对话框组件
- script.ts：脚本状态管理 Store
- scriptEngine.ts：脚本执行引擎（使用 new Function 创建沙箱）
- 集成点：PublishPanel、ScheduledPublishDialog、mqtt.ts 消息监听